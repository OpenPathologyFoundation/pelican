# Large Image Server - Authentication Guide

This document explains the JWT authentication system implemented in the Large Image Server and provides step-by-step instructions for deployment and usage.

## Table of Contents

1. [Overview](#overview)
2. [How JWT Authentication Works](#how-jwt-authentication-works)
3. [Architecture](#architecture)
4. [Configuration](#configuration)
5. [Running the Server](#running-the-server)
6. [Testing Authentication](#testing-authentication)
7. [Integration with Frontend Applications](#integration-with-frontend-applications)
8. [Docker Deployment](#docker-deployment)
9. [Troubleshooting](#troubleshooting)

---

## Overview

The Large Image Server provides a REST API for serving tiles from large multi-resolution images (pathology slides, geospatial images, etc.). The server now includes **optional JWT (JSON Web Token) authentication** that can be enabled to secure access to all tile-serving endpoints.

### Key Points

- **Authentication is OPTIONAL** - By default, the server runs without authentication (open access)
- **When enabled**, all API endpoints require a valid JWT Bearer token
- **The server does NOT generate tokens** - tokens must be generated by an external authentication service (your identity provider)
- **The server ONLY validates tokens** - it checks that tokens are properly signed and not expired

---

## How JWT Authentication Works

### What is JWT?

JWT (JSON Web Token) is an industry-standard method for securely transmitting information between parties. A JWT consists of three parts:

```
header.payload.signature
```

Example token:
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyMTIzIiwiZXhwIjoxNzA2MDE4MDAwfQ.abc123signature
```

### Authentication Flow

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  User/Browser   │     │  Auth Service   │     │  Tile Server    │
│                 │     │  (Your IdP)     │     │  (This Server)  │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         │  1. Login (username/  │                       │
         │     password)         │                       │
         │──────────────────────>│                       │
         │                       │                       │
         │  2. JWT Token         │                       │
         │<──────────────────────│                       │
         │                       │                       │
         │  3. Request tiles with Authorization header   │
         │  Authorization: Bearer <token>                │
         │──────────────────────────────────────────────>│
         │                       │                       │
         │                       │    4. Validate token  │
         │                       │       (check signature│
         │                       │        & expiration)  │
         │                       │                       │
         │  5. Tile data (if valid) or 401 error        │
         │<──────────────────────────────────────────────│
         │                       │                       │
```

### Who Does What?

| Component | Responsibility |
|-----------|---------------|
| **Authentication Service (Your IdP)** | Authenticates users, generates JWT tokens |
| **Large Image Server (This)** | Validates JWT tokens, serves tiles if valid |
| **Client Application** | Obtains token from IdP, includes token in requests |

The tile server **never sees passwords** - it only validates that a token was properly signed by a trusted authority.

---

## Architecture

### Files Involved

```
utilities/server/
├── large_image_server/
│   ├── __init__.py          # App factory, includes JWT middleware
│   ├── auth.py              # JWT authentication module (NEW)
│   ├── config.py            # Server settings including JWT config
│   └── routes/
│       └── __init__.py      # API router with JWT dependency
├── Dockerfile               # Container deployment (NEW)
└── README_AUTH.md           # This file
```

### auth.py Module

The authentication module provides:

- `OptionalJWTBearer` - FastAPI security scheme that validates Bearer tokens
- `verify_jwt_token()` - Function that decodes and validates JWT tokens
- `jwt_bearer` - Dependency that can be added to routes

When JWT is **disabled** (default):
- The `jwt_bearer` dependency returns `None`
- All requests are allowed through

When JWT is **enabled**:
- Every request must include `Authorization: Bearer <token>` header
- Invalid/missing tokens result in 401 Unauthorized response

---

## Configuration

### Environment Variables

All settings can be configured via environment variables with the prefix `LARGE_IMAGE_SERVER_`:

| Variable | Default | Description |
|----------|---------|-------------|
| `LARGE_IMAGE_SERVER_JWT_ENABLED` | `false` | Enable/disable JWT authentication |
| `LARGE_IMAGE_SERVER_JWT_SECRET` | `None` | **Required if enabled.** Secret key for HS256/HS384/HS512 algorithms |
| `LARGE_IMAGE_SERVER_JWT_ALGORITHM` | `HS256` | JWT signing algorithm |
| `LARGE_IMAGE_SERVER_JWT_AUDIENCE` | `None` | Expected `aud` claim in token (optional) |
| `LARGE_IMAGE_SERVER_JWT_ISSUER` | `None` | Expected `iss` claim in token (optional) |

### Supported Algorithms

- **Symmetric (shared secret)**: `HS256`, `HS384`, `HS512`
- **Asymmetric (public/private key)**: `RS256`, `RS384`, `RS512`

For asymmetric algorithms, `JWT_SECRET` should contain the public key.

### Example: Minimal Configuration

```bash
export LARGE_IMAGE_SERVER_JWT_ENABLED=true
export LARGE_IMAGE_SERVER_JWT_SECRET="your-256-bit-secret-key-here"
```

### Example: Full Configuration

```bash
export LARGE_IMAGE_SERVER_JWT_ENABLED=true
export LARGE_IMAGE_SERVER_JWT_SECRET="your-256-bit-secret-key-here"
export LARGE_IMAGE_SERVER_JWT_ALGORITHM="HS256"
export LARGE_IMAGE_SERVER_JWT_AUDIENCE="pathology-viewer"
export LARGE_IMAGE_SERVER_JWT_ISSUER="https://auth.yourcompany.com"
```

---

## Running the Server

### Prerequisites

```bash
# Install the server (from utilities/server directory)
pip install -e ".[jwt]"
```

### Without Authentication (Default)

```bash
# Simple - no authentication required
large_image_server --image-dir /path/to/test-cases --port 8000
```

Access any endpoint directly:
```bash
curl http://localhost:8000/health
curl http://localhost:8000/images
```

### With Authentication Enabled

```bash
# Set environment variables first
export LARGE_IMAGE_SERVER_JWT_ENABLED=true
export LARGE_IMAGE_SERVER_JWT_SECRET="my-super-secret-key-at-least-32-chars"

# Start the server
large_image_server --image-dir /path/to/test-cases --port 8000
```

Now requests require authentication:
```bash
# This will fail with 401 Unauthorized
curl http://localhost:8000/images

# This will succeed (with valid token)
curl -H "Authorization: Bearer <your-jwt-token>" http://localhost:8000/images
```

---

## Testing Authentication

### Step 1: Generate a Test Token

For testing purposes, you can generate a token using Python:

```python
# generate_test_token.py
import jwt
from datetime import datetime, timedelta

SECRET = "my-super-secret-key-at-least-32-chars"

payload = {
    "sub": "test-user",           # Subject (user ID)
    "name": "Test User",          # User's name
    "exp": datetime.utcnow() + timedelta(hours=1),  # Expires in 1 hour
    "iat": datetime.utcnow(),     # Issued at
}

token = jwt.encode(payload, SECRET, algorithm="HS256")
print(f"Token: {token}")
```

Run it:
```bash
pip install PyJWT
python generate_test_token.py
```
e.g.: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXIiLCJuYW1lIjoiVGVzdCBVc2VyIiwiaWF0IjoxNzY5MTIwODQyLCJleHAiOjE3NjkxMjQ0NDJ9.A5vIUs7h4WLyfP818a8xCsdBRpMPlQgx-N2V_O8rVOA



### Step 2: Start Server with Authentication

```bash
export LARGE_IMAGE_SERVER_JWT_ENABLED=true
export LARGE_IMAGE_SERVER_JWT_SECRET="my-super-secret-key-at-least-32-chars"
export LARGE_IMAGE_SERVER_IMAGE_DIR=/path/to/test-cases

large_image_server
```

### Step 3: Test the Endpoints

```bash
# Get your token from Step 1
TOKEN="eyJhbGciOiJIUzI1NiIs..."

# Test health endpoint (always public)
curl http://localhost:8000/health

# Test protected endpoint without token (should fail)
curl http://localhost:8000/images
# Response: {"detail":"Authorization header missing"}

# Test protected endpoint with token (should succeed)
curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/images
# Response: ["image1.svs", "image2.ndpi", ...]

# Test tile endpoint
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8000/tiles/sample.svs/5/10/10.jpeg" \
  --output tile.jpeg
```

### Step 4: Test Token Validation

Test with an invalid token:
```bash
curl -H "Authorization: Bearer invalid-token" http://localhost:8000/images
# Response: {"detail":"Invalid token: Not enough segments"}
```

Test with an expired token:
```bash
# Generate an already-expired token
python -c "
import jwt
from datetime import datetime, timedelta
token = jwt.encode({'sub': 'test', 'exp': datetime.utcnow() - timedelta(hours=1)},
                   'my-super-secret-key-at-least-32-chars', algorithm='HS256')
print(token)
"
# Use that token
curl -H "Authorization: Bearer <expired-token>" http://localhost:8000/images
# Response: {"detail":"Token has expired"}
```

---

## Integration with Frontend Applications

### JavaScript/TypeScript Example

```typescript
// tile-client.ts
class TileClient {
  private baseUrl: string;
  private token: string | null = null;

  constructor(baseUrl: string) {
    this.baseUrl = baseUrl;
  }

  setToken(token: string) {
    this.token = token;
  }

  private getHeaders(): HeadersInit {
    const headers: HeadersInit = {};
    if (this.token) {
      headers['Authorization'] = `Bearer ${this.token}`;
    }
    return headers;
  }

  async getImages(): Promise<string[]> {
    const response = await fetch(`${this.baseUrl}/images`, {
      headers: this.getHeaders(),
    });
    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('Authentication required');
      }
      throw new Error(`HTTP ${response.status}`);
    }
    return response.json();
  }

  getTileUrl(imageId: string, z: number, x: number, y: number): string {
    // For OpenSeadragon, include token in URL or use custom tile source
    return `${this.baseUrl}/tiles/${encodeURIComponent(imageId)}/${z}/${x}/${y}.jpeg`;
  }
}

// Usage with your auth system
const client = new TileClient('http://localhost:8000');

// After user logs in and you get a token from your auth service:
client.setToken(authService.getAccessToken());

// Now API calls include the token
const images = await client.getImages();
```

### OpenSeadragon with Authentication

```typescript
// Custom tile source that adds auth header
class AuthenticatedDZITileSource extends OpenSeadragon.TileSource {
  private token: string;

  constructor(options: any, token: string) {
    super(options);
    this.token = token;
  }

  getTileUrl(level: number, x: number, y: number): string {
    // OpenSeadragon will call this for each tile
    return `${this.tilesUrl}/${level}/${x}_${y}.jpeg`;
  }

  // Override to add auth header
  getTileAjaxHeaders(level: number, x: number, y: number): Record<string, string> {
    return {
      'Authorization': `Bearer ${this.token}`,
    };
  }
}
```

---

## Docker Deployment

### Build the Image

```bash
cd utilities/server
docker build -t large-image-server .
```

### Run Without Authentication

```bash
docker run -p 8000:8000 \
  -v /path/to/your/slides:/images \
  large-image-server
```

### Run With Authentication

```bash
docker run -p 8000:8000 \
  -e LARGE_IMAGE_SERVER_JWT_ENABLED=true \
  -e LARGE_IMAGE_SERVER_JWT_SECRET="your-secret-key-here" \
  -v /path/to/your/slides:/images \
  large-image-server
```

### Docker Compose Example

```yaml
# docker-compose.yml
version: '3.8'

services:
  tile-server:
    build: ./utilities/server
    ports:
      - "8000:8000"
    environment:
      - LARGE_IMAGE_SERVER_JWT_ENABLED=true
      - LARGE_IMAGE_SERVER_JWT_SECRET=${JWT_SECRET}
      - LARGE_IMAGE_SERVER_JWT_ISSUER=https://auth.example.com
    volumes:
      - ./slides:/images:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

Run with:
```bash
JWT_SECRET="your-secret-key" docker-compose up
```

---

## Troubleshooting

### "Authorization header missing"

**Cause**: JWT is enabled but request doesn't include Authorization header.

**Solution**: Include the header:
```bash
curl -H "Authorization: Bearer <token>" http://localhost:8000/images
```

### "Token has expired"

**Cause**: The JWT's `exp` claim is in the past.

**Solution**: Generate a new token from your authentication service.

### "Invalid token: Not enough segments"

**Cause**: The token string is malformed (not a valid JWT format).

**Solution**: Ensure you're passing a complete JWT token (three base64 segments separated by dots).

### "Invalid token audience" / "Invalid token issuer"

**Cause**: Token's `aud` or `iss` claims don't match server configuration.

**Solution**: Either:
- Configure the server to match your token's claims
- Generate tokens with matching claims

### "PyJWT is not installed"

**Cause**: JWT is enabled but the PyJWT library isn't installed.

**Solution**:
```bash
pip install PyJWT
# or
pip install -e ".[jwt]"
```

### Server starts but authentication doesn't seem to work

**Check**: Is JWT actually enabled?
```bash
curl http://localhost:8000/health
# Look at the response - if it works without a token, JWT might be disabled
```

**Verify configuration**:
```python
from large_image_server.config import get_settings
settings = get_settings()
print(f"JWT Enabled: {settings.jwt_enabled}")
print(f"JWT Secret: {'SET' if settings.jwt_secret else 'NOT SET'}")
```

---

## Security Considerations

1. **Keep your secret key secure** - Never commit it to version control
2. **Use environment variables** - Don't hardcode secrets in configuration files
3. **Use HTTPS in production** - JWT tokens should only be transmitted over encrypted connections
4. **Set appropriate token expiration** - Short-lived tokens (1 hour or less) are more secure
5. **Rotate secrets periodically** - Change your JWT secret regularly
6. **Consider asymmetric algorithms** - RS256 allows you to validate tokens without knowing the signing key

---

## Quick Reference

### Start server (no auth)
```bash
large_image_server --image-dir ./test-cases
```

### Start server (with auth)
```bash
export LARGE_IMAGE_SERVER_JWT_ENABLED=true
export LARGE_IMAGE_SERVER_JWT_SECRET="your-secret-key"
large_image_server --image-dir ./test-cases
```

### Make authenticated request
```bash
curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/images
```

### Generate test token
```python
import jwt
from datetime import datetime, timedelta
token = jwt.encode(
    {"sub": "user", "exp": datetime.utcnow() + timedelta(hours=1)},
    "your-secret-key",
    algorithm="HS256"
)
```
